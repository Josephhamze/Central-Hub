// Prisma Schema for Operations Control Panel
// Core system entities only - no business data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & AUTHORIZATION
// ============================================================================

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  passwordHash  String        @map("password_hash")
  firstName     String        @map("first_name")
  lastName      String        @map("last_name")
  // Status fields - separate account status from verification
  accountStatus AccountStatus @default(ACTIVE) @map("account_status")
  emailVerified Boolean       @default(false) @map("email_verified")
  // Deactivation tracking
  deactivatedAt DateTime?     @map("deactivated_at")
  deactivatedBy String?       @map("deactivated_by")
  lastLoginAt   DateTime?     @map("last_login_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Preferences
  themePreference ThemePreference @default(SYSTEM) @map("theme_preference")

  // Relations
  roles                        UserRole[]
  refreshTokens                RefreshToken[]
  auditLogs                    AuditLog[]
  salesQuotes                  Quote[]              @relation("SalesRepQuotes")
  quoteApprovals               QuoteApprovalAudit[] @relation("QuoteApprovalActors")
  notifications                Notification[]       @relation("UserNotifications")
  workOrders                   WorkOrder[]          @relation("WorkOrderAssignments")
  assetHistory                 AssetHistory[]       @relation("AssetHistoryActors")
  createdInviteCodes           InviteCode[]         @relation("InviteCodeCreator")
  usedInviteCode               InviteCode?          @relation("InviteCodeUser")
  createdRoutes                Route[]              @relation("RouteCreator")
  createdCostProfiles          RouteCostProfile[]   @relation("RouteCostProfileCreator")
  tollPaymentsPaidBy           TollPayment[]        @relation("TollPaymentPaidBy")
  routeRequestsRequested       RouteRequest[]       @relation("RouteRequestRequester")
  routeRequestsReviewed        RouteRequest[]       @relation("RouteRequestReviewer")
  // Quarry Production Relations
  excavatorEntriesAsOperator   ExcavatorEntry[]     @relation("ExcavatorOperator")
  haulingEntriesAsDriver       HaulingEntry[]       @relation("TruckDriver")
  excavatorEntriesCreated      ExcavatorEntry[]     @relation("ExcavatorEntryCreator")
  haulingEntriesCreated        HaulingEntry[]       @relation("HaulingEntryCreator")
  crusherFeedEntriesCreated    CrusherFeedEntry[]   @relation("CrusherFeedEntryCreator")
  crusherOutputEntriesCreated  CrusherOutputEntry[] @relation("CrusherOutputEntryCreator")
  excavatorEntriesApproved     ExcavatorEntry[]     @relation("ExcavatorEntryApprover")
  haulingEntriesApproved       HaulingEntry[]       @relation("HaulingEntryApprover")
  crusherFeedEntriesApproved   CrusherFeedEntry[]   @relation("CrusherFeedEntryApprover")
  crusherOutputEntriesApproved CrusherOutputEntry[] @relation("CrusherOutputEntryApprover")
  stockLevelsCreated           StockLevel[]         @relation("StockLevelCreator")

  @@index([accountStatus])
  @@index([emailVerified])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  module      String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  roles RolePermission[]

  @@index([module])
  @@map("permissions")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String    @map("user_id")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================================================
// AUDIT & SYSTEM
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("system_settings")
}

// Invite Code for user registration
model InviteCode {
  id        String    @id @default(cuid())
  code      String    @unique
  createdBy String    @map("created_by") // User ID of admin who created it
  usedBy    String?   @unique @map("used_by") // User ID who used it (null if unused) - unique since one user can only use one code
  usedAt    DateTime? @map("used_at")
  expiresAt DateTime? @map("expires_at") // Optional expiration
  maxUses   Int       @default(1) @map("max_uses") // How many times it can be used
  useCount  Int       @default(0) @map("use_count") // How many times it's been used
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  creator User? @relation("InviteCodeCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  user    User? @relation("InviteCodeUser", fields: [usedBy], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([createdBy])
  @@index([isActive])
  @@index([expiresAt])
  @@map("invite_codes")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AccountStatus {
  ACTIVE
  DISABLED
  PENDING
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}

// ============================================================================
// SALES QUOTE SYSTEM
// ============================================================================

enum CustomerType {
  INDIVIDUAL
  COMPANY
}

enum DeliveryMethod {
  DELIVERED
  COLLECTED
}

enum QuoteStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  WON
  LOST
}

enum PaymentTerms {
  CASH_ON_DELIVERY
  DAYS_15
  DAYS_30
}

enum TruckType {
  TIPPER_42T
  FLATBED_40T
}

enum VehicleType {
  FLATBED
  TIPPER
}

enum LossReasonCategory {
  PRICE_TOO_HIGH
  FOUND_BETTER_DEAL
  PROJECT_CANCELLED
  DELIVERY_TIMING
  QUALITY_CONCERNS
  OTHER
}

enum ApprovalAction {
  SUBMIT
  APPROVE
  REJECT
  WITHDRAW
  MARK_WON
  MARK_LOST
}

// Company Directory
model Company {
  id           String   @id @default(cuid())
  name         String
  legalName    String?  @map("legal_name")
  nif          String?  @map("nif")
  rccm         String?  @map("rccm")
  idNational   String?  @map("id_national")
  vat          String?  @map("vat")
  addressLine1 String?  @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String?
  state        String?
  country      String?
  phone        String?
  email        String?
  logoUrl      String?  @map("logo_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  projects       Project[]
  warehouses     Warehouse[]
  quotes         Quote[]
  assets         Asset[]
  quarrySettings QuarrySettings? @relation("QuarryDefaultCompany")

  @@map("companies")
}

// Quarry Production Settings
model QuarrySettings {
  id               String   @id @default(cuid())
  defaultCompanyId String?  @unique @map("default_company_id") // Default company for quarry operations (one-to-one)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  defaultCompany Company? @relation("QuarryDefaultCompany", fields: [defaultCompanyId], references: [id], onDelete: SetNull)

  @@map("quarry_settings")
}

// Project
model Project {
  id        String   @id @default(cuid())
  companyId String   @map("company_id")
  name      String
  code      String?
  region    String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company              Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  warehouses           Warehouse[]
  stockItems           StockItem[]
  quotes               Quote[]
  assets               Asset[]
  // Quarry Production Relations
  excavatorEntries     ExcavatorEntry[]
  haulingEntries       HaulingEntry[]
  crusherFeedEntries   CrusherFeedEntry[]
  crusherOutputEntries CrusherOutputEntry[]
  stockLevels          StockLevel[]

  @@index([companyId])
  @@map("projects")
}

// Warehouse
model Warehouse {
  id           String   @id @default(cuid())
  companyId    String   @map("company_id")
  projectId    String?  @map("project_id")
  name         String
  locationCity String?  @map("location_city")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project       Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  stockItems    StockItem[]
  routes        Route[]
  routeRequests RouteRequest[]
  assets        Asset[]
  spareParts    SparePart[]

  @@index([companyId])
  @@index([projectId])
  @@map("warehouses")
}

// Customer
model Customer {
  id                   String       @id @default(cuid())
  type                 CustomerType
  // Individual fields
  firstName            String?      @map("first_name")
  lastName             String?      @map("last_name")
  // Company fields
  companyName          String?      @map("company_name")
  // Common fields
  billingAddressLine1  String       @map("billing_address_line1")
  billingAddressLine2  String?      @map("billing_address_line2")
  billingCity          String       @map("billing_city")
  billingState         String?      @map("billing_state")
  billingPostalCode    String       @map("billing_postal_code")
  billingCountry       String?      @map("billing_country")
  deliveryAddressLine1 String?      @map("delivery_address_line1")
  deliveryAddressLine2 String?      @map("delivery_address_line2")
  deliveryCity         String?      @map("delivery_city")
  deliveryState        String?      @map("delivery_state")
  deliveryPostalCode   String?      @map("delivery_postal_code")
  deliveryCountry      String?      @map("delivery_country")
  phone                String?
  email                String?
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  // Relations
  contacts Contact[]
  quotes   Quote[]

  @@index([type])
  @@map("customers")
}

// Contact
model Contact {
  id         String   @id @default(cuid())
  customerId String   @map("customer_id")
  name       String
  roleTitle  String?  @map("role_title")
  phone      String?
  email      String?
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  quotes   Quote[]

  @@index([customerId])
  @@map("contacts")
}

// Stock Item (Product)
model StockItem {
  id               String   @id @default(cuid())
  projectId        String   @map("project_id")
  warehouseId      String   @map("warehouse_id")
  name             String
  sku              String?
  uom              String // Unit of measure
  minUnitPrice     Decimal  @map("min_unit_price") @db.Decimal(10, 2)
  defaultUnitPrice Decimal  @map("default_unit_price") @db.Decimal(10, 2)
  minOrderQty      Decimal  @map("min_order_qty") @db.Decimal(10, 2)
  truckloadOnly    Boolean  @default(false) @map("truckload_only")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  quoteItems  QuoteItem[]
  stockLevels StockLevel[] // Quarry production stock levels linked to this stock item

  @@index([projectId])
  @@index([warehouseId])
  @@index([name])
  @@index([isActive])
  @@index([sku])
  @@map("stock_items")
}

// Route (Admin-only)
model Route {
  id              String   @id @default(cuid())
  fromCity        String   @map("from_city")
  toCity          String   @map("to_city")
  distanceKm      Decimal  @map("distance_km") @db.Decimal(10, 2)
  costPerKm       Decimal? @map("cost_per_km") @db.Decimal(10, 2) // Rate per km for transport calculation
  timeHours       Decimal? @map("time_hours") @db.Decimal(8, 2)
  warehouseId     String?  @map("warehouse_id") // Link to warehouse
  isActive        Boolean  @default(true) @map("is_active")
  notes           String?
  createdByUserId String?  @map("created_by_user_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  tolls                 Toll[] // Legacy tolls, kept for backward compatibility
  quotes                Quote[]
  tollStations          RouteTollStation[]
  costingScenarios      RouteCostingScenario[]
  tollPayments          TollPayment[]
  snapshots             RouteSnapshot[]
  warehouse             Warehouse?             @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  creator               User?                  @relation("RouteCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  approvedRouteRequests RouteRequest[]         @relation("RouteRequestApprovedRoute")

  @@index([fromCity])
  @@index([toCity])
  @@index([isActive])
  @@index([createdByUserId])
  @@index([warehouseId])
  @@map("routes")
}

// Route Request (for user-submitted route requests pending admin approval)
model RouteRequest {
  id                String             @id @default(cuid())
  fromCity          String?            @map("from_city")
  toCity            String?            @map("to_city")
  distanceKm        Decimal?           @map("distance_km") @db.Decimal(10, 2)
  timeHours         Decimal?           @map("time_hours") @db.Decimal(8, 2)
  warehouseId       String?            @map("warehouse_id")
  notes             String?
  quoteId           String?            @map("quote_id")
  status            RouteRequestStatus @default(PENDING)
  requestedByUserId String             @map("requested_by_user_id")
  reviewedByUserId  String?            @map("reviewed_by_user_id")
  reviewedAt        DateTime?          @map("reviewed_at")
  rejectionReason   String?            @map("rejection_reason")
  approvedRouteId   String?            @map("approved_route_id")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  // Relations
  warehouse     Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  requestedBy   User       @relation("RouteRequestRequester", fields: [requestedByUserId], references: [id], onDelete: Cascade)
  reviewedBy    User?      @relation("RouteRequestReviewer", fields: [reviewedByUserId], references: [id], onDelete: SetNull)
  quote         Quote?     @relation(fields: [quoteId], references: [id], onDelete: SetNull)
  approvedRoute Route?     @relation("RouteRequestApprovedRoute", fields: [approvedRouteId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([requestedByUserId])
  @@index([reviewedByUserId])
  @@index([quoteId])
  @@map("route_requests")
}

enum RouteRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Toll (Legacy - kept for backward compatibility)
model Toll {
  id        String   @id @default(cuid())
  routeId   String   @map("route_id")
  name      String
  cost      Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
  @@map("tolls")
}

// ============================================================================
// ROUTES & TOLLS SYSTEM
// ============================================================================

// Toll Station
model TollStation {
  id         String   @id @default(cuid())
  name       String
  cityOrArea String?  @map("city_or_area")
  code       String?  @unique
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  rates         TollRate[]
  routeStations RouteTollStation[]
  payments      TollPayment[]

  @@index([isActive])
  @@index([code])
  @@map("toll_stations")
}

// Toll Rate (per station + vehicle type)
model TollRate {
  id            String      @id @default(cuid())
  tollStationId String      @map("toll_station_id")
  vehicleType   VehicleType @map("vehicle_type")
  amount        Decimal     @db.Decimal(10, 2)
  currency      String      @default("USD")
  effectiveFrom DateTime?   @map("effective_from")
  effectiveTo   DateTime?   @map("effective_to")
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  tollStation TollStation @relation(fields: [tollStationId], references: [id], onDelete: Cascade)

  @@index([tollStationId])
  @@index([vehicleType])
  @@index([isActive])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@map("toll_rates")
}

// Route Toll Station (join table for ordered stations per route)
model RouteTollStation {
  id            String   @id @default(cuid())
  routeId       String   @map("route_id")
  tollStationId String   @map("toll_station_id")
  sortOrder     Int      @map("sort_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  route       Route       @relation(fields: [routeId], references: [id], onDelete: Cascade)
  tollStation TollStation @relation(fields: [tollStationId], references: [id], onDelete: Cascade)

  @@unique([routeId, tollStationId, sortOrder])
  @@index([routeId])
  @@index([tollStationId])
  @@index([isActive])
  @@map("route_toll_stations")
}

// Route Cost Profile
model RouteCostProfile {
  id              String      @id @default(cuid())
  name            String
  vehicleType     VehicleType @map("vehicle_type")
  currency        String      @default("USD")
  isActive        Boolean     @default(true) @map("is_active")
  configJson      Json        @map("config_json") // Validated schema for cost components
  createdByUserId String?     @map("created_by_user_id")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  creator   User?                  @relation("RouteCostProfileCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)
  scenarios RouteCostingScenario[]

  @@index([vehicleType])
  @@index([isActive])
  @@index([createdByUserId])
  @@map("route_cost_profiles")
}

// Route Costing Scenario
model RouteCostingScenario {
  id                     String   @id @default(cuid())
  routeId                String   @map("route_id")
  costProfileId          String   @map("cost_profile_id")
  tripsPerMonth          Decimal? @map("trips_per_month") @db.Decimal(10, 2)
  plannedTonnagePerMonth Decimal? @map("planned_tonnage_per_month") @db.Decimal(10, 2)
  isActive               Boolean  @default(true) @map("is_active")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relations
  route       Route            @relation(fields: [routeId], references: [id], onDelete: Cascade)
  costProfile RouteCostProfile @relation(fields: [costProfileId], references: [id], onDelete: Cascade)

  @@unique([routeId, costProfileId])
  @@index([routeId])
  @@index([costProfileId])
  @@index([isActive])
  @@map("route_costing_scenarios")
}

// Toll Payment Status
enum TollPaymentStatus {
  DRAFT
  SUBMITTED
  APPROVED
  POSTED
}

// Toll Payment
model TollPayment {
  id            String            @id @default(cuid())
  paidAt        DateTime          @map("paid_at")
  vehicleType   VehicleType       @map("vehicle_type")
  routeId       String?           @map("route_id")
  tollStationId String?           @map("toll_station_id")
  amount        Decimal           @db.Decimal(10, 2)
  currency      String            @default("USD")
  receiptRef    String?           @map("receipt_ref")
  paidByUserId  String?           @map("paid_by_user_id")
  notes         String?
  status        TollPaymentStatus @default(DRAFT)
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  // Relations
  route       Route?                  @relation(fields: [routeId], references: [id], onDelete: SetNull)
  tollStation TollStation?            @relation(fields: [tollStationId], references: [id], onDelete: SetNull)
  paidBy      User?                   @relation("TollPaymentPaidBy", fields: [paidByUserId], references: [id], onDelete: SetNull)
  attachments TollPaymentAttachment[]

  @@index([paidAt])
  @@index([vehicleType])
  @@index([routeId])
  @@index([tollStationId])
  @@index([status])
  @@index([paidByUserId])
  @@map("toll_payments")
}

// Toll Payment Attachment
model TollPaymentAttachment {
  id            String   @id @default(cuid())
  tollPaymentId String   @map("toll_payment_id")
  filePath      String   @map("file_path")
  fileName      String   @map("file_name")
  mimeType      String?  @map("mime_type")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  tollPayment TollPayment @relation(fields: [tollPaymentId], references: [id], onDelete: Cascade)

  @@index([tollPaymentId])
  @@map("toll_payment_attachments")
}

// Route Snapshot (for quoting/immutability)
model RouteSnapshot {
  id           String   @id @default(cuid())
  routeId      String   @map("route_id")
  snapshotJson Json     @map("snapshot_json") // Contains distance/time/stations + rates + profile config used
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
  @@index([createdAt])
  @@map("route_snapshots")
}

// Quote
model Quote {
  id                   String              @id @default(cuid())
  quoteNumber          String              @unique @map("quote_number")
  companyId            String              @map("company_id")
  projectId            String              @map("project_id")
  customerId           String              @map("customer_id")
  contactId            String?             @map("contact_id")
  deliveryMethod       DeliveryMethod      @map("delivery_method")
  // Delivery address snapshot
  deliveryAddressLine1 String?             @map("delivery_address_line1")
  deliveryAddressLine2 String?             @map("delivery_address_line2")
  deliveryCity         String?             @map("delivery_city")
  deliveryState        String?             @map("delivery_state")
  deliveryPostalCode   String?             @map("delivery_postal_code")
  deliveryCountry      String?             @map("delivery_country")
  // Route snapshot
  routeId              String?             @map("route_id")
  distanceKmSnapshot   Decimal?            @map("distance_km_snapshot") @db.Decimal(10, 2)
  costPerKmSnapshot    Decimal?            @map("cost_per_km_snapshot") @db.Decimal(10, 2)
  tollTotalSnapshot    Decimal?            @map("toll_total_snapshot") @db.Decimal(10, 2)
  // Totals
  subtotal             Decimal             @db.Decimal(12, 2)
  discountPercentage   Decimal             @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  transportTotal       Decimal             @default(0) @map("transport_total") @db.Decimal(12, 2)
  grandTotal           Decimal             @map("grand_total") @db.Decimal(12, 2)
  // Validity
  validityDays         Int                 @default(7) @map("validity_days")
  expiresAt            DateTime?           @map("expires_at") // Calculated from approvedAt or createdAt + validityDays
  // Payment Terms
  paymentTerms         PaymentTerms?       @map("payment_terms")
  // Delivery Terms
  deliveryStartDate    DateTime?           @map("delivery_start_date")
  serviceEndDate       DateTime?           @map("service_end_date")
  loadsPerDay          Int?                @map("loads_per_day")
  truckType            TruckType?          @map("truck_type")
  // Status
  status               QuoteStatus         @default(DRAFT)
  // Archiving
  archived             Boolean             @default(false) @map("archived")
  archivedAt           DateTime?           @map("archived_at")
  // Sales rep
  salesRepUserId       String              @map("sales_rep_user_id")
  // Relations to User
  salesRep             User                @relation("SalesRepQuotes", fields: [salesRepUserId], references: [id], onDelete: Cascade)
  // Timestamps
  submittedAt          DateTime?           @map("submitted_at")
  approvedAt           DateTime?           @map("approved_at")
  rejectedAt           DateTime?           @map("rejected_at")
  // Outcome (only for LOST quotes)
  lossReasonCategory   LossReasonCategory? @map("loss_reason_category")
  outcomeReasonNotes   String?             @map("outcome_reason_notes")
  createdAt            DateTime            @default(now()) @map("created_at")
  updatedAt            DateTime            @updatedAt @map("updated_at")

  // Relations
  company       Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project       Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  customer      Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact       Contact?             @relation(fields: [contactId], references: [id], onDelete: SetNull)
  route         Route?               @relation(fields: [routeId], references: [id], onDelete: SetNull)
  items         QuoteItem[]
  approvals     QuoteApprovalAudit[]
  routeRequests RouteRequest[]

  @@index([companyId])
  @@index([projectId])
  @@index([customerId])
  @@index([salesRepUserId])
  @@index([status])
  @@index([quoteNumber])
  @@index([archived])
  @@index([expiresAt])
  @@map("quotes")
}

// Quote Item
model QuoteItem {
  id                 String   @id @default(cuid())
  quoteId            String   @map("quote_id")
  stockItemId        String   @map("stock_item_id")
  // Snapshots
  nameSnapshot       String   @map("name_snapshot")
  uomSnapshot        String   @map("uom_snapshot")
  // Pricing
  qty                Decimal  @db.Decimal(10, 2)
  unitPrice          Decimal  @map("unit_price") @db.Decimal(10, 2)
  discountPercentage Decimal  @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  lineTotal          Decimal  @map("line_total") @db.Decimal(12, 2)
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  quote     Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  stockItem StockItem @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([stockItemId])
  @@map("quote_items")
}

// Quote Approval Audit
model QuoteApprovalAudit {
  id          String         @id @default(cuid())
  quoteId     String         @map("quote_id")
  action      ApprovalAction
  actorUserId String         @map("actor_user_id")
  // Relations to User
  actor       User           @relation("QuoteApprovalActors", fields: [actorUserId], references: [id], onDelete: Cascade)
  notes       String?
  createdAt   DateTime       @default(now()) @map("created_at")

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([actorUserId])
  @@map("quote_approval_audits")
}

// Notifications
model Notification {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  type      String // e.g., 'quote_approved', 'quote_rejected', 'quote_submitted'
  title     String
  message   String
  read      Boolean   @default(false)
  link      String? // Optional link to related resource
  createdAt DateTime  @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")

  // Relations
  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// ASSETS & MAINTENANCE SYSTEM
// ============================================================================

enum AssetStatus {
  OPERATIONAL
  MAINTENANCE
  BROKEN
  RETIRED
}

enum AssetCriticality {
  LOW
  MEDIUM
  HIGH
}

enum MaintenanceScheduleType {
  TIME_BASED
  USAGE_BASED
}

enum WorkOrderType {
  PREVENTIVE
  CORRECTIVE
  INSPECTION
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  CANCELLED
}

enum DepreciationMethod {
  STRAIGHT_LINE
  DECLINING_BALANCE
}

enum AssetHistoryEventType {
  CREATED
  STATUS_CHANGED
  MAINTENANCE_DONE
  WORK_ORDER_COMPLETED
  PART_CONSUMED
  COST_UPDATED
  RETIRED
}

enum IndexType {
  HOURS
  KILOMETERS
  MILES
  CYCLES
  UNITS
  OTHER
}

enum AssetLifecycleStatus {
  NEW
  IN_SERVICE
  UNDER_MAINTENANCE
  IDLE
  RETIRED
  DISPOSED
}

// Asset Registry
model Asset {
  id       String @id @default(cuid())
  assetTag String @unique @map("asset_tag")

  // ASSET IDENTITY
  name         String  @map("asset_name")
  category     String // Crusher, Truck, Generator, etc.
  type         String? // Specific type of asset
  family       String? // System generated asset family
  manufacturer String?
  model        String?
  yearModel    Int?    @map("year_model")
  color        String?

  // ALLOCATION
  companyId             String? @map("company_id")
  projectId             String? @map("project_id")
  companyCode           String? @map("company_code")
  countryOfRegistration String? @map("country_of_registration")
  currentLocation       String? @map("current_location")
  parentAssetId         String? @map("parent_asset_id")

  // IDENTIFICATION
  serialNumber       String? @map("serial_number")
  chassisNumber      String? @map("chassis_number")
  engineNumber       String? @map("engine_number")
  registrationNumber String? @map("registration_number")

  // FINANCIAL INFORMATION
  purchaseDate       DateTime? @map("purchase_date")
  purchaseValue      Decimal?  @map("purchase_value") @db.Decimal(12, 2)
  currency           String?   @default("USD")
  brandNewValue      Decimal?  @map("brand_new_value") @db.Decimal(12, 2)
  currentMarketValue Decimal?  @map("current_market_value") @db.Decimal(12, 2)
  residualValue      Decimal?  @map("residual_value") @db.Decimal(12, 2)
  purchaseOrder      String?   @map("purchase_order")
  glAccount          String?   @map("gl_account")

  // LIFECYCLE
  installDate          DateTime?             @map("install_date")
  endOfLifeDate        DateTime?             @map("end_of_life_date")
  disposalDate         DateTime?             @map("disposal_date")
  assetLifecycleStatus AssetLifecycleStatus? @map("asset_lifecycle_status")

  // INDEX DETAILS
  indexType       IndexType? @map("index_type")
  currentIndex    Decimal?   @map("current_index") @db.Decimal(12, 2)
  indexAtPurchase Decimal?   @map("index_at_purchase") @db.Decimal(12, 2)
  lastIndexDate   DateTime?  @map("last_index_date")

  // STATUS
  status              AssetStatus @default(OPERATIONAL)
  statusSince         DateTime?   @map("status_since")
  availabilityPercent Decimal?    @map("availability_percent") @db.Decimal(5, 2)
  lastOperator        String?     @map("last_operator")

  // MAINTENANCE
  lastMaintenanceDate DateTime? @map("last_maintenance_date")
  nextMaintenanceDate DateTime? @map("next_maintenance_date")
  maintenanceBudget   Decimal?  @map("maintenance_budget") @db.Decimal(12, 2)

  // Legacy fields (kept for backward compatibility)
  acquisitionDate   DateTime?        @map("acquisition_date")
  acquisitionCost   Decimal?         @map("acquisition_cost") @db.Decimal(12, 2)
  currentValue      Decimal?         @map("current_value") @db.Decimal(12, 2)
  location          String? // site / project / warehouse
  warehouseId       String?          @map("warehouse_id")
  assignedTo        String?          @map("assigned_to") // operator or department
  criticality       AssetCriticality @default(MEDIUM)
  expectedLifeYears Int?             @map("expected_life_years")
  notes             String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company              Company?              @relation(fields: [companyId], references: [id], onDelete: SetNull)
  project              Project?              @relation(fields: [projectId], references: [id], onDelete: SetNull)
  warehouse            Warehouse?            @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  parentAsset          Asset?                @relation("AssetHierarchy", fields: [parentAssetId], references: [id], onDelete: SetNull)
  childAssets          Asset[]               @relation("AssetHierarchy")
  maintenanceSchedules MaintenanceSchedule[]
  workOrders           WorkOrder[]
  history              AssetHistory[]
  depreciationProfile  DepreciationProfile?
  depreciationEntries  DepreciationEntry[]
  // Quarry Production Relations
  excavator            Excavator?            @relation("ExcavatorAsset")
  truck                Truck?                @relation("TruckAsset")
  crusher              Crusher?              @relation("CrusherAsset")

  @@index([assetTag])
  @@index([status])
  @@index([category])
  @@index([projectId])
  @@index([companyId])
  @@index([warehouseId])
  @@index([parentAssetId])
  @@map("assets")
}

// Maintenance Schedules (Preventive)
model MaintenanceSchedule {
  id                     String                  @id @default(cuid())
  assetId                String                  @map("asset_id")
  type                   MaintenanceScheduleType
  intervalDays           Int?                    @map("interval_days") // for time-based
  intervalHours          Int?                    @map("interval_hours") // for usage-based
  checklistJson          Json?                   @map("checklist_json")
  estimatedDurationHours Decimal?                @map("estimated_duration_hours") @db.Decimal(5, 2)
  requiredPartsJson      Json?                   @map("required_parts_json")
  isActive               Boolean                 @default(true) @map("is_active")
  lastPerformedAt        DateTime?               @map("last_performed_at")
  nextDueAt              DateTime?               @map("next_due_at")
  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")

  // Relations
  asset      Asset       @relation(fields: [assetId], references: [id], onDelete: Cascade)
  workOrders WorkOrder[]

  @@index([assetId])
  @@index([isActive])
  @@index([nextDueAt])
  @@map("maintenance_schedules")
}

// Work Orders (Corrective + Preventive)
model WorkOrder {
  id               String            @id @default(cuid())
  assetId          String            @map("asset_id")
  scheduleId       String?           @map("schedule_id")
  type             WorkOrderType
  priority         WorkOrderPriority @default(MEDIUM)
  status           WorkOrderStatus   @default(OPEN)
  description      String
  assignedToUserId String?           @map("assigned_to_user_id")
  startedAt        DateTime?         @map("started_at")
  completedAt      DateTime?         @map("completed_at")
  downtimeHours    Decimal?          @map("downtime_hours") @db.Decimal(10, 2)
  laborCost        Decimal           @default(0) @map("labor_cost") @db.Decimal(12, 2)
  partsCost        Decimal           @default(0) @map("parts_cost") @db.Decimal(12, 2)
  totalCost        Decimal           @default(0) @map("total_cost") @db.Decimal(12, 2)
  notes            String?
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  // Relations
  asset      Asset                @relation(fields: [assetId], references: [id], onDelete: Cascade)
  schedule   MaintenanceSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  assignedTo User?                @relation("WorkOrderAssignments", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  partUsages PartUsage[]

  @@index([assetId])
  @@index([scheduleId])
  @@index([status])
  @@index([assignedToUserId])
  @@index([createdAt])
  @@map("work_orders")
}

// Spare Parts
model SparePart {
  id             String   @id @default(cuid())
  name           String
  sku            String   @unique
  uom            String // Unit of measure
  warehouseId    String   @map("warehouse_id")
  quantityOnHand Decimal  @default(0) @map("quantity_on_hand") @db.Decimal(10, 2)
  minStockLevel  Decimal  @default(0) @map("min_stock_level") @db.Decimal(10, 2)
  unitCost       Decimal  @map("unit_cost") @db.Decimal(10, 2)
  isCritical     Boolean  @default(false) @map("is_critical")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  warehouse  Warehouse   @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  partUsages PartUsage[]

  @@index([sku])
  @@index([warehouseId])
  @@map("spare_parts")
}

// Part Usage (consumption tracking)
model PartUsage {
  id           String   @id @default(cuid())
  workOrderId  String   @map("work_order_id")
  sparePartId  String   @map("spare_part_id")
  quantityUsed Decimal  @map("quantity_used") @db.Decimal(10, 2)
  costSnapshot Decimal  @map("cost_snapshot") @db.Decimal(10, 2)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  sparePart SparePart @relation(fields: [sparePartId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([sparePartId])
  @@map("part_usages")
}

// Asset History (Immutable Log)
model AssetHistory {
  id           String                @id @default(cuid())
  assetId      String                @map("asset_id")
  eventType    AssetHistoryEventType @map("event_type")
  metadataJson Json?                 @map("metadata_json")
  actorUserId  String?               @map("actor_user_id")
  createdAt    DateTime              @default(now()) @map("created_at")

  // Relations
  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  actor User? @relation("AssetHistoryActors", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([assetId])
  @@index([eventType])
  @@index([createdAt])
  @@map("asset_history")
}

// Depreciation Profile
model DepreciationProfile {
  id              String             @id @default(cuid())
  assetId         String             @unique @map("asset_id")
  method          DepreciationMethod
  usefulLifeYears Int                @map("useful_life_years")
  salvageValue    Decimal            @map("salvage_value") @db.Decimal(12, 2)
  startDate       DateTime           @map("start_date")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  asset   Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  entries DepreciationEntry[]

  @@index([assetId])
  @@map("depreciation_profiles")
}

// Depreciation Entry
model DepreciationEntry {
  id                 String    @id @default(cuid())
  assetId            String    @map("asset_id")
  profileId          String    @map("profile_id")
  period             String // YYYY-MM format
  depreciationAmount Decimal   @map("depreciation_amount") @db.Decimal(12, 2)
  bookValueAfter     Decimal   @map("book_value_after") @db.Decimal(12, 2)
  isPosted           Boolean   @default(false) @map("is_posted")
  postedAt           DateTime? @map("posted_at")
  createdAt          DateTime  @default(now()) @map("created_at")

  // Relations
  asset   Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  profile DepreciationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([assetId, period])
  @@index([assetId])
  @@index([profileId])
  @@index([period])
  @@index([isPosted])
  @@map("depreciation_entries")
}

// ============================================================================
// QUARRY PRODUCTION TRACKING SYSTEM
// ============================================================================

// Enums
enum Shift {
  DAY
  NIGHT
}

enum EquipmentStatus {
  ACTIVE
  MAINTENANCE
  DECOMMISSIONED
}

enum CrusherType {
  PRIMARY_JAW
  SECONDARY_CONE
  TERTIARY_VSI
  SCREEN
}

enum EntryStatus {
  PENDING
  APPROVED
  REJECTED
}

enum QualityGrade {
  PREMIUM
  STANDARD
  OFF_SPEC
}

// Equipment Models (Master Data)
model Excavator {
  id             String          @id @default(cuid())
  name           String          @unique
  bucketCapacity Decimal         @map("bucket_capacity") @db.Decimal(8, 2) // cubic meters
  status         EquipmentStatus @default(ACTIVE)
  assetId        String?         @unique @map("asset_id") // Link to Asset model (one-to-one)
  notes          String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  // Relations
  entries ExcavatorEntry[]
  asset   Asset?           @relation("ExcavatorAsset", fields: [assetId], references: [id], onDelete: SetNull)

  @@index([status])
  @@map("excavators")
}

model Truck {
  id           String          @id @default(cuid())
  name         String          @unique
  loadCapacity Decimal         @map("load_capacity") @db.Decimal(8, 2) // tonnes
  status       EquipmentStatus @default(ACTIVE)
  assetId      String?         @unique @map("asset_id") // Link to Asset model (one-to-one)
  notes        String?
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  // Relations
  entries HaulingEntry[]
  asset   Asset?         @relation("TruckAsset", fields: [assetId], references: [id], onDelete: SetNull)

  @@index([status])
  @@map("trucks")
}

model Crusher {
  id            String          @id @default(cuid())
  name          String          @unique
  type          CrusherType
  ratedCapacity Decimal         @map("rated_capacity") @db.Decimal(10, 2) // tonnes per hour
  status        EquipmentStatus @default(ACTIVE)
  assetId       String?         @unique @map("asset_id") // Link to Asset model (one-to-one)
  notes         String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  feedEntries   CrusherFeedEntry[]
  outputEntries CrusherOutputEntry[]
  asset         Asset?               @relation("CrusherAsset", fields: [assetId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([type])
  @@map("crushers")
}

// Reference Data Models
model PitLocation {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  entries ExcavatorEntry[]

  @@index([isActive])
  @@map("pit_locations")
}

model MaterialType {
  id        String   @id @default(cuid())
  name      String   @unique
  density   Decimal  @db.Decimal(8, 2) // tonnes per cubic meter
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  excavatorEntries   ExcavatorEntry[]
  crusherFeedEntries CrusherFeedEntry[]

  @@index([isActive])
  @@map("material_types")
}

model ProductType {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  outputEntries CrusherOutputEntry[]
  stockLevels   StockLevel[]

  @@index([isActive])
  @@map("product_types")
}

model StockpileLocation {
  id        String   @id @default(cuid())
  name      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  outputEntries CrusherOutputEntry[]
  stockLevels   StockLevel[]

  @@index([isActive])
  @@map("stockpile_locations")
}

// Production Entry Models
model ExcavatorEntry {
  id               String      @id @default(cuid())
  date             DateTime    @db.Date
  shift            Shift
  projectId        String      @map("project_id") // Link to Project
  excavatorId      String      @map("excavator_id")
  operatorId       String      @map("operator_id")
  materialTypeId   String      @map("material_type_id")
  pitLocationId    String      @map("pit_location_id")
  bucketCount      Int         @map("bucket_count")
  estimatedVolume  Decimal     @map("estimated_volume") @db.Decimal(10, 2) // auto-calculated
  estimatedTonnage Decimal     @map("estimated_tonnage") @db.Decimal(10, 2) // auto-calculated
  downtimeHours    Decimal?    @map("downtime_hours") @db.Decimal(5, 2)
  notes            String?
  status           EntryStatus @default(PENDING)
  approverId       String?     @map("approver_id")
  approvedAt       DateTime?   @map("approved_at")
  createdById      String      @map("created_by_id")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relations
  project              Project        @relation(fields: [projectId], references: [id], onDelete: Restrict)
  excavator            Excavator      @relation(fields: [excavatorId], references: [id], onDelete: Restrict)
  operator             User           @relation("ExcavatorOperator", fields: [operatorId], references: [id], onDelete: Restrict)
  materialType         MaterialType   @relation(fields: [materialTypeId], references: [id], onDelete: Restrict)
  pitLocation          PitLocation    @relation(fields: [pitLocationId], references: [id], onDelete: Restrict)
  createdBy            User           @relation("ExcavatorEntryCreator", fields: [createdById], references: [id], onDelete: Restrict)
  approver             User?          @relation("ExcavatorEntryApprover", fields: [approverId], references: [id], onDelete: SetNull)
  linkedHaulingEntries HaulingEntry[]

  @@unique([date, shift, projectId, excavatorId, operatorId])
  @@index([date])
  @@index([shift])
  @@index([projectId])
  @@index([excavatorId])
  @@index([operatorId])
  @@index([status])
  @@index([createdById])
  @@map("excavator_entries")
}

model HaulingEntry {
  id               String      @id @default(cuid())
  date             DateTime    @db.Date
  shift            Shift
  projectId        String      @map("project_id") // Link to Project
  truckId          String      @map("truck_id")
  driverId         String      @map("driver_id")
  excavatorEntryId String?     @map("excavator_entry_id") // Optional link to source
  tripCount        Int         @map("trip_count")
  totalHauled      Decimal     @map("total_hauled") @db.Decimal(10, 2) // auto-calculated
  avgCycleTime     Decimal?    @map("avg_cycle_time") @db.Decimal(5, 2) // minutes
  fuelConsumption  Decimal?    @map("fuel_consumption") @db.Decimal(8, 2) // liters
  notes            String?
  status           EntryStatus @default(PENDING)
  approverId       String?     @map("approver_id")
  approvedAt       DateTime?   @map("approved_at")
  createdById      String      @map("created_by_id")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  // Relations
  project              Project         @relation(fields: [projectId], references: [id], onDelete: Restrict)
  truck                Truck           @relation(fields: [truckId], references: [id], onDelete: Restrict)
  driver               User            @relation("TruckDriver", fields: [driverId], references: [id], onDelete: Restrict)
  sourceExcavatorEntry ExcavatorEntry? @relation(fields: [excavatorEntryId], references: [id], onDelete: SetNull)
  createdBy            User            @relation("HaulingEntryCreator", fields: [createdById], references: [id], onDelete: Restrict)
  approver             User?           @relation("HaulingEntryApprover", fields: [approverId], references: [id], onDelete: SetNull)

  @@unique([date, shift, projectId, truckId, driverId])
  @@index([date])
  @@index([shift])
  @@index([projectId])
  @@index([truckId])
  @@index([driverId])
  @@index([excavatorEntryId])
  @@index([status])
  @@index([createdById])
  @@map("hauling_entries")
}

model CrusherFeedEntry {
  id                    String      @id @default(cuid())
  date                  DateTime    @db.Date
  shift                 Shift
  projectId             String      @map("project_id") // Link to Project
  crusherId             String      @map("crusher_id")
  materialTypeId        String      @map("material_type_id")
  feedStartTime         DateTime    @map("feed_start_time")
  feedEndTime           DateTime    @map("feed_end_time")
  truckLoadsReceived    Int         @map("truck_loads_received")
  weighBridgeTonnage    Decimal     @map("weigh_bridge_tonnage") @db.Decimal(10, 2) // source of truth
  feedRate              Decimal?    @map("feed_rate") @db.Decimal(10, 2) // auto-calculated: tonnage / operating hours
  rejectOversizeTonnage Decimal?    @map("reject_oversize_tonnage") @db.Decimal(10, 2)
  notes                 String?
  status                EntryStatus @default(PENDING)
  approverId            String?     @map("approver_id")
  approvedAt            DateTime?   @map("approved_at")
  createdById           String      @map("created_by_id")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  // Relations
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Restrict)
  crusher      Crusher      @relation(fields: [crusherId], references: [id], onDelete: Restrict)
  materialType MaterialType @relation(fields: [materialTypeId], references: [id], onDelete: Restrict)
  createdBy    User         @relation("CrusherFeedEntryCreator", fields: [createdById], references: [id], onDelete: Restrict)
  approver     User?        @relation("CrusherFeedEntryApprover", fields: [approverId], references: [id], onDelete: SetNull)

  @@unique([date, shift, projectId, crusherId])
  @@index([date])
  @@index([shift])
  @@index([projectId])
  @@index([crusherId])
  @@index([status])
  @@index([createdById])
  @@map("crusher_feed_entries")
}

model CrusherOutputEntry {
  id                  String       @id @default(cuid())
  date                DateTime     @db.Date
  shift               Shift
  projectId           String       @map("project_id") // Link to Project
  crusherId           String       @map("crusher_id")
  productTypeId       String       @map("product_type_id")
  stockpileLocationId String       @map("stockpile_location_id")
  outputTonnage       Decimal      @map("output_tonnage") @db.Decimal(10, 2)
  yieldPercentage     Decimal?     @map("yield_percentage") @db.Decimal(5, 2) // auto-calculated
  qualityGrade        QualityGrade @map("quality_grade")
  moisturePercentage  Decimal?     @map("moisture_percentage") @db.Decimal(5, 2)
  notes               String?
  status              EntryStatus  @default(PENDING)
  approverId          String?      @map("approver_id")
  approvedAt          DateTime?    @map("approved_at")
  createdById         String       @map("created_by_id")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)
  crusher           Crusher           @relation(fields: [crusherId], references: [id], onDelete: Restrict)
  productType       ProductType       @relation(fields: [productTypeId], references: [id], onDelete: Restrict)
  stockpileLocation StockpileLocation @relation(fields: [stockpileLocationId], references: [id], onDelete: Restrict)
  createdBy         User              @relation("CrusherOutputEntryCreator", fields: [createdById], references: [id], onDelete: Restrict)
  approver          User?             @relation("CrusherOutputEntryApprover", fields: [approverId], references: [id], onDelete: SetNull)

  @@index([date])
  @@index([shift])
  @@index([projectId])
  @@index([crusherId])
  @@index([productTypeId])
  @@index([stockpileLocationId])
  @@index([status])
  @@index([createdById])
  @@map("crusher_output_entries")
}

// Stock Management
model StockLevel {
  id                  String   @id @default(cuid())
  date                DateTime @db.Date
  projectId           String   @map("project_id") // Link to Project
  productTypeId       String   @map("product_type_id")
  stockpileLocationId String   @map("stockpile_location_id")
  stockItemId         String?  @map("stock_item_id") // Optional link to StockItem for syncing
  openingStock        Decimal  @map("opening_stock") @db.Decimal(12, 2) // from previous day's closing
  produced            Decimal  @default(0) @db.Decimal(12, 2) // summed from approved crusher output entries
  sold                Decimal  @default(0) @db.Decimal(12, 2) // from sales/dispatch or manual entry
  adjustments         Decimal  @default(0) @db.Decimal(12, 2) // manual corrections
  adjustmentReason    String?  @map("adjustment_reason")
  closingStock        Decimal  @map("closing_stock") @db.Decimal(12, 2) // auto-calculated: opening + produced - sold + adjustments
  createdById         String   @map("created_by_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  project           Project           @relation(fields: [projectId], references: [id], onDelete: Restrict)
  productType       ProductType       @relation(fields: [productTypeId], references: [id], onDelete: Restrict)
  stockpileLocation StockpileLocation @relation(fields: [stockpileLocationId], references: [id], onDelete: Restrict)
  stockItem         StockItem?        @relation(fields: [stockItemId], references: [id], onDelete: SetNull)
  createdBy         User              @relation("StockLevelCreator", fields: [createdById], references: [id], onDelete: Restrict)

  @@unique([date, projectId, productTypeId, stockpileLocationId])
  @@index([date])
  @@index([projectId])
  @@index([productTypeId])
  @@index([stockpileLocationId])
  @@index([stockItemId])
  @@map("stock_levels")
}

// ============================================================================
// PROPERTY MANAGEMENT SYSTEM (PMS)
// ============================================================================

// Enums for Property Management
enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  MIXED_USE
  INDUSTRIAL
  LAND
}

enum OwnershipType {
  OWNED
  LEASED
  MANAGED
}

enum PropertyStatus {
  VACANT
  OCCUPIED
  UNDER_MAINTENANCE
  LISTED
  INACTIVE
}

enum TenantStatus {
  ACTIVE
  LATE
  VACATED
  BLACKLISTED
  PENDING
}

enum LeaseType {
  FIXED
  MONTH_TO_MONTH
  YEARLY
}

enum PaymentFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHECK
  CREDIT_CARD
  MOBILE_PAYMENT
  OTHER
}

enum RentPaymentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  WAIVED
  REFUNDED
}

enum UtilityType {
  ELECTRICITY
  WATER
  GAS
  INTERNET
  REFUSE
  SECURITY
  SEWAGE
  OTHER
}

enum ExpenseCategory {
  MAINTENANCE
  REPAIRS
  MUNICIPAL_TAXES
  INSURANCE
  MANAGEMENT_FEE
  LEGAL
  MARKETING
  CLEANING
  LANDSCAPING
  PEST_CONTROL
  OTHER
}

enum BillAllocation {
  LANDLORD
  TENANT
  SHARED
}

enum BillStatus {
  PENDING
  PAID
  OVERDUE
  DISPUTED
  CANCELLED
}

enum PropertyHealthStatus {
  HEALTHY
  AT_RISK
  UNDERPERFORMING
  NON_PERFORMING
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaintenanceStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

// Property Asset Registry
model Property {
  id           String       @id @default(cuid())
  propertyCode String       @unique @map("property_code") // e.g., PROP-001
  name         String
  propertyType PropertyType @map("property_type")

  // Address
  addressLine1 String   @map("address_line1")
  addressLine2 String?  @map("address_line2")
  city         String
  state        String?
  postalCode   String?  @map("postal_code")
  country      String
  gpsLatitude  Decimal? @map("gps_latitude") @db.Decimal(10, 8)
  gpsLongitude Decimal? @map("gps_longitude") @db.Decimal(11, 8)

  // Physical Details
  unitCount     Int      @default(1) @map("unit_count")
  floorArea     Decimal? @map("floor_area") @db.Decimal(10, 2) // sqm
  plotSize      Decimal? @map("plot_size") @db.Decimal(10, 2) // sqm
  floors        Int?
  bedrooms      Int?
  bathrooms     Int?
  parkingSpaces Int?     @map("parking_spaces")
  yearBuilt     Int?     @map("year_built")
  description   String?
  amenities     Json? // Array of amenities

  // Ownership & Status
  ownershipType OwnershipType         @map("ownership_type")
  status        PropertyStatus        @default(VACANT)
  healthStatus  PropertyHealthStatus? @map("health_status")

  // Financial
  purchaseDate       DateTime? @map("purchase_date")
  purchaseValue      Decimal?  @map("purchase_value") @db.Decimal(14, 2)
  currentMarketValue Decimal?  @map("current_market_value") @db.Decimal(14, 2)
  currentRentalValue Decimal?  @map("current_rental_value") @db.Decimal(12, 2) // Monthly
  currency           String    @default("USD")

  // Market Data
  marketRentEstimate Decimal?  @map("market_rent_estimate") @db.Decimal(12, 2)
  lastValuationDate  DateTime? @map("last_valuation_date")

  // Rental Escalation
  annualEscalationPct Decimal? @map("annual_escalation_pct") @db.Decimal(5, 2) // e.g., 5.00 for 5%

  // Documents & Images
  documentsJson Json? @map("documents_json") // Array of document references
  imagesJson    Json? @map("images_json") // Array of image URLs

  // Relationships
  parentPropertyId String? @map("parent_property_id")
  companyId        String? @map("company_id")

  // Audit
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  parentProperty  Property?                @relation("PropertyHierarchy", fields: [parentPropertyId], references: [id], onDelete: SetNull)
  childProperties Property[]               @relation("PropertyHierarchy")
  units           PropertyUnit[]
  leases          Lease[]
  expenses        PropertyExpense[]
  utilityBills    UtilityBill[]
  maintenanceJobs PropertyMaintenanceJob[]
  kpiSnapshots    PropertyKPISnapshot[]

  @@index([propertyCode])
  @@index([propertyType])
  @@index([status])
  @@index([healthStatus])
  @@index([city])
  @@index([companyId])
  @@index([parentPropertyId])
  @@map("properties")
}

// Property Unit (Sub-asset)
model PropertyUnit {
  id         String @id @default(cuid())
  propertyId String @map("property_id")
  unitCode   String @map("unit_code") // e.g., APT-101
  name       String // e.g., "Apartment 101"

  // Physical Details
  floorNumber   Int?     @map("floor_number")
  floorArea     Decimal? @map("floor_area") @db.Decimal(10, 2) // sqm
  bedrooms      Int?
  bathrooms     Int?
  parkingSpaces Int?     @map("parking_spaces")
  hasBalcony    Boolean  @default(false) @map("has_balcony")
  hasFurnished  Boolean  @default(false) @map("has_furnished")
  description   String?
  amenities     Json?

  // Status
  status PropertyStatus @default(VACANT)

  // Financial
  baseRentalValue    Decimal? @map("base_rental_value") @db.Decimal(12, 2)
  currentRentalValue Decimal? @map("current_rental_value") @db.Decimal(12, 2)
  currency           String   @default("USD")

  // Meters
  electricityMeter String? @map("electricity_meter")
  waterMeter       String? @map("water_meter")
  gasMeter         String? @map("gas_meter")

  // Documents & Images
  imagesJson Json? @map("images_json")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  property        Property                 @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  leases          Lease[]
  utilityBills    UtilityBill[]
  maintenanceJobs PropertyMaintenanceJob[]

  @@unique([propertyId, unitCode])
  @@index([propertyId])
  @@index([status])
  @@map("property_units")
}

// Tenant Registry
model Tenant {
  id         String @id @default(cuid())
  tenantCode String @unique @map("tenant_code") // e.g., TEN-001

  // Identity
  isCompany   Boolean @default(false) @map("is_company")
  firstName   String? @map("first_name")
  lastName    String? @map("last_name")
  companyName String? @map("company_name")

  // Contact
  email          String?
  phone          String?
  alternatePhone String? @map("alternate_phone")

  // Identification
  idType   String? @map("id_type") // Passport, National ID, etc.
  idNumber String? @map("id_number")
  taxId    String? @map("tax_id")

  // Address (permanent)
  addressLine1 String? @map("address_line1")
  addressLine2 String? @map("address_line2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")
  country      String?

  // Emergency Contact
  emergencyContactName  String? @map("emergency_contact_name")
  emergencyContactPhone String? @map("emergency_contact_phone")

  // Status
  status         TenantStatus @default(PENDING)
  currentBalance Decimal      @default(0) @map("current_balance") @db.Decimal(12, 2) // + credit, - arrears

  // Documents
  documentsJson Json? @map("documents_json")

  // Notes
  notes           String?
  blacklistReason String? @map("blacklist_reason")

  // Audit
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  leases       Lease[]
  rentPayments RentPayment[]

  @@index([tenantCode])
  @@index([status])
  @@index([email])
  @@map("tenants")
}

// Lease Agreement
model Lease {
  id        String @id @default(cuid())
  leaseCode String @unique @map("lease_code") // e.g., LSE-001

  // Links
  tenantId   String  @map("tenant_id")
  propertyId String  @map("property_id")
  unitId     String? @map("unit_id")

  // Lease Terms
  leaseType  LeaseType @map("lease_type")
  startDate  DateTime  @map("start_date")
  endDate    DateTime? @map("end_date")
  signedDate DateTime? @map("signed_date")

  // Financial Terms
  rentAmount        Decimal          @map("rent_amount") @db.Decimal(12, 2)
  depositAmount     Decimal          @default(0) @map("deposit_amount") @db.Decimal(12, 2)
  paymentFrequency  PaymentFrequency @map("payment_frequency")
  paymentDueDay     Int              @default(1) @map("payment_due_day") // Day of month
  gracePeriodDays   Int              @default(5) @map("grace_period_days")
  lateFeeAmount     Decimal?         @map("late_fee_amount") @db.Decimal(10, 2)
  lateFeePercentage Decimal?         @map("late_fee_percentage") @db.Decimal(5, 2)
  currency          String           @default("USD")

  // Escalation
  hasEscalation      Boolean   @default(false) @map("has_escalation")
  escalationPct      Decimal?  @map("escalation_pct") @db.Decimal(5, 2)
  escalationDate     DateTime? @map("escalation_date") // Anniversary or fixed date
  nextEscalationDate DateTime? @map("next_escalation_date")

  // Payment Method
  preferredPaymentMethod PaymentMethod? @map("preferred_payment_method")

  // Status
  isActive          Boolean   @default(true) @map("is_active")
  terminatedDate    DateTime? @map("terminated_date")
  terminationReason String?   @map("termination_reason")

  // Utilities Responsibility
  utilitiesIncluded Json? @map("utilities_included") // Array of UtilityType

  // Documents
  contractDocumentUrl String? @map("contract_document_url")
  documentsJson       Json?   @map("documents_json")

  // Notes
  specialTerms String? @map("special_terms")
  notes        String?

  // Audit
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  property      Property       @relation(fields: [propertyId], references: [id], onDelete: Restrict)
  unit          PropertyUnit?  @relation(fields: [unitId], references: [id], onDelete: SetNull)
  rentPayments  RentPayment[]
  rentSchedules RentSchedule[]

  @@index([leaseCode])
  @@index([tenantId])
  @@index([propertyId])
  @@index([unitId])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
  @@map("leases")
}

// Rent Schedule (Generated billing periods)
model RentSchedule {
  id      String @id @default(cuid())
  leaseId String @map("lease_id")

  // Period
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  dueDate     DateTime @map("due_date")

  // Amounts
  rentAmount        Decimal @map("rent_amount") @db.Decimal(12, 2)
  additionalCharges Decimal @default(0) @map("additional_charges") @db.Decimal(12, 2)
  totalDue          Decimal @map("total_due") @db.Decimal(12, 2)

  // Payment Status
  amountPaid Decimal           @default(0) @map("amount_paid") @db.Decimal(12, 2)
  balance    Decimal           @map("balance") @db.Decimal(12, 2) // totalDue - amountPaid
  status     RentPaymentStatus @default(PENDING)

  // Late Fee
  lateFeeApplied Decimal @default(0) @map("late_fee_applied") @db.Decimal(10, 2)

  // Notes
  notes String?

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  lease    Lease         @relation(fields: [leaseId], references: [id], onDelete: Cascade)
  payments RentPayment[]

  @@unique([leaseId, periodStart])
  @@index([leaseId])
  @@index([dueDate])
  @@index([status])
  @@map("rent_schedules")
}

// Rent Payment
model RentPayment {
  id          String @id @default(cuid())
  paymentCode String @unique @map("payment_code") // e.g., PAY-001

  // Links
  tenantId       String  @map("tenant_id")
  leaseId        String  @map("lease_id")
  rentScheduleId String? @map("rent_schedule_id")

  // Payment Details
  paymentDate     DateTime      @map("payment_date")
  amount          Decimal       @map("amount") @db.Decimal(12, 2)
  paymentMethod   PaymentMethod @map("payment_method")
  referenceNumber String?       @map("reference_number") // Check number, transfer ref, etc.

  // Allocation
  rentPortion     Decimal @default(0) @map("rent_portion") @db.Decimal(12, 2)
  lateFeesPortion Decimal @default(0) @map("late_fees_portion") @db.Decimal(12, 2)
  depositPortion  Decimal @default(0) @map("deposit_portion") @db.Decimal(12, 2)
  otherPortion    Decimal @default(0) @map("other_portion") @db.Decimal(12, 2)

  // Status
  status   RentPaymentStatus @default(PAID)
  isRefund Boolean           @default(false) @map("is_refund")

  // Receipt
  receiptNumber String? @map("receipt_number")
  receiptUrl    String? @map("receipt_url")

  // Notes
  notes String?

  // Audit
  receivedById String?  @map("received_by_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  lease        Lease         @relation(fields: [leaseId], references: [id], onDelete: Restrict)
  rentSchedule RentSchedule? @relation(fields: [rentScheduleId], references: [id], onDelete: SetNull)

  @@index([paymentCode])
  @@index([tenantId])
  @@index([leaseId])
  @@index([rentScheduleId])
  @@index([paymentDate])
  @@index([status])
  @@map("rent_payments")
}

// Property Expense
model PropertyExpense {
  id          String @id @default(cuid())
  expenseCode String @unique @map("expense_code") // e.g., EXP-001

  // Links
  propertyId String @map("property_id")

  // Expense Details
  category    ExpenseCategory
  description String
  vendor      String?

  // Period
  expenseDate DateTime  @map("expense_date")
  periodStart DateTime? @map("period_start")
  periodEnd   DateTime? @map("period_end")

  // Financial
  amount      Decimal  @map("amount") @db.Decimal(12, 2)
  currency    String   @default("USD")
  taxAmount   Decimal? @map("tax_amount") @db.Decimal(10, 2)
  totalAmount Decimal  @map("total_amount") @db.Decimal(12, 2)

  // Payment
  isPaid           Boolean        @default(false) @map("is_paid")
  paidDate         DateTime?      @map("paid_date")
  paymentMethod    PaymentMethod? @map("payment_method")
  paymentReference String?        @map("payment_reference")

  // Recurrence
  isRecurring        Boolean           @default(false) @map("is_recurring")
  recurringFrequency PaymentFrequency? @map("recurring_frequency")

  // Documents
  invoiceNumber String? @map("invoice_number")
  invoiceUrl    String? @map("invoice_url")
  receiptUrl    String? @map("receipt_url")

  // Notes
  notes String?

  // Budget
  budgetCategory String? @map("budget_category")
  isCapex        Boolean @default(false) @map("is_capex") // Capital vs Operating expense

  // Audit
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([expenseCode])
  @@index([propertyId])
  @@index([category])
  @@index([expenseDate])
  @@index([isPaid])
  @@map("property_expenses")
}

// Utility Bill
model UtilityBill {
  id       String @id @default(cuid())
  billCode String @unique @map("bill_code") // e.g., UTIL-001

  // Links
  propertyId String  @map("property_id")
  unitId     String? @map("unit_id")

  // Utility Details
  utilityType   UtilityType @map("utility_type")
  provider      String?
  accountNumber String?     @map("account_number")

  // Period
  billingPeriodStart DateTime @map("billing_period_start")
  billingPeriodEnd   DateTime @map("billing_period_end")
  billDate           DateTime @map("bill_date")
  dueDate            DateTime @map("due_date")

  // Meter Readings
  previousReading Decimal? @map("previous_reading") @db.Decimal(12, 2)
  currentReading  Decimal? @map("current_reading") @db.Decimal(12, 2)
  consumption     Decimal? @db.Decimal(12, 2) // currentReading - previousReading
  consumptionUnit String?  @map("consumption_unit") // kWh, cubic meters, etc.

  // Financial
  amount      Decimal  @map("amount") @db.Decimal(12, 2)
  taxAmount   Decimal? @map("tax_amount") @db.Decimal(10, 2)
  totalAmount Decimal  @map("total_amount") @db.Decimal(12, 2)
  currency    String   @default("USD")

  // Allocation
  allocation     BillAllocation @default(LANDLORD)
  tenantSharePct Decimal?       @map("tenant_share_pct") @db.Decimal(5, 2) // For SHARED

  // Status
  status           BillStatus @default(PENDING)
  paidDate         DateTime?  @map("paid_date")
  paidAmount       Decimal?   @map("paid_amount") @db.Decimal(12, 2)
  paymentReference String?    @map("payment_reference")

  // Documents
  billUrl String? @map("bill_url")

  // Notes
  notes String?

  // Audit
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  property Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit     PropertyUnit? @relation(fields: [unitId], references: [id], onDelete: SetNull)

  @@index([billCode])
  @@index([propertyId])
  @@index([unitId])
  @@index([utilityType])
  @@index([billingPeriodStart])
  @@index([status])
  @@index([dueDate])
  @@map("utility_bills")
}

// Property Maintenance Job (links to project management)
model PropertyMaintenanceJob {
  id      String @id @default(cuid())
  jobCode String @unique @map("job_code") // e.g., MNT-001

  // Links
  propertyId  String  @map("property_id")
  unitId      String? @map("unit_id")
  workOrderId String? @map("work_order_id") // Link to existing WorkOrder

  // Job Details
  title       String
  description String
  category    ExpenseCategory
  priority    MaintenancePriority @default(MEDIUM)

  // Status
  status MaintenanceStatus @default(PENDING)

  // Scheduling
  reportedDate  DateTime  @map("reported_date")
  scheduledDate DateTime? @map("scheduled_date")
  startedDate   DateTime? @map("started_date")
  completedDate DateTime? @map("completed_date")

  // Assignment
  assignedTo   String? @map("assigned_to") // Contractor name or internal
  contractorId String? @map("contractor_id")

  // Financial
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(12, 2)
  actualCost    Decimal? @map("actual_cost") @db.Decimal(12, 2)
  currency      String   @default("USD")
  budgetCode    String?  @map("budget_code")

  // Impact
  affectsOccupancy  Boolean @default(false) @map("affects_occupancy")
  vacancyDaysImpact Int?    @map("vacancy_days_impact")

  // Documents
  beforePhotosJson Json?   @map("before_photos_json")
  afterPhotosJson  Json?   @map("after_photos_json")
  invoiceUrl       String? @map("invoice_url")

  // Tenant Reported
  reportedByTenantId   String? @map("reported_by_tenant_id")
  tenantAccessRequired Boolean @default(false) @map("tenant_access_required")

  // Notes
  notes           String?
  resolutionNotes String? @map("resolution_notes")

  // Audit
  createdById String?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  property Property      @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit     PropertyUnit? @relation(fields: [unitId], references: [id], onDelete: SetNull)

  @@index([jobCode])
  @@index([propertyId])
  @@index([unitId])
  @@index([status])
  @@index([priority])
  @@index([scheduledDate])
  @@map("property_maintenance_jobs")
}

// Property KPI Snapshot (for historical tracking)
model PropertyKPISnapshot {
  id           String   @id @default(cuid())
  propertyId   String   @map("property_id")
  snapshotDate DateTime @map("snapshot_date")
  period       String // YYYY-MM format

  // Operational KPIs
  occupancyRate      Decimal? @map("occupancy_rate") @db.Decimal(5, 2) // %
  vacancyRate        Decimal? @map("vacancy_rate") @db.Decimal(5, 2) // %
  totalUnits         Int?     @map("total_units")
  occupiedUnits      Int?     @map("occupied_units")
  vacantUnits        Int?     @map("vacant_units")
  avgLeaseDuration   Decimal? @map("avg_lease_duration") @db.Decimal(8, 2) // months
  tenantTurnoverRate Decimal? @map("tenant_turnover_rate") @db.Decimal(5, 2) // %
  activeLeases       Int?     @map("active_leases")
  expiringLeases30   Int?     @map("expiring_leases_30") // Expiring in 30 days
  expiringLeases60   Int?     @map("expiring_leases_60") // Expiring in 60 days
  expiringLeases90   Int?     @map("expiring_leases_90") // Expiring in 90 days

  // Financial KPIs
  rentalIncome      Decimal? @map("rental_income") @db.Decimal(14, 2)
  rentCollected     Decimal? @map("rent_collected") @db.Decimal(14, 2)
  rentBilled        Decimal? @map("rent_billed") @db.Decimal(14, 2)
  collectionRate    Decimal? @map("collection_rate") @db.Decimal(5, 2) // %
  arrearsAmount     Decimal? @map("arrears_amount") @db.Decimal(14, 2)
  arrearsPercentage Decimal? @map("arrears_percentage") @db.Decimal(5, 2) // %

  operatingExpenses Decimal? @map("operating_expenses") @db.Decimal(14, 2)
  maintenanceCosts  Decimal? @map("maintenance_costs") @db.Decimal(14, 2)
  utilityCosts      Decimal? @map("utility_costs") @db.Decimal(14, 2)

  netOperatingIncome Decimal? @map("net_operating_income") @db.Decimal(14, 2) // NOI
  grossYield         Decimal? @map("gross_yield") @db.Decimal(5, 2) // %
  netYield           Decimal? @map("net_yield") @db.Decimal(5, 2) // %
  cashFlow           Decimal? @map("cash_flow") @db.Decimal(14, 2)

  // Property Value
  marketValue Decimal? @map("market_value") @db.Decimal(14, 2)
  capRate     Decimal? @map("cap_rate") @db.Decimal(5, 2) // Capitalization Rate %

  // Health Status
  healthStatus PropertyHealthStatus? @map("health_status")

  // Currency
  currency String @default("USD")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, period])
  @@index([propertyId])
  @@index([snapshotDate])
  @@index([period])
  @@map("property_kpi_snapshots")
}
