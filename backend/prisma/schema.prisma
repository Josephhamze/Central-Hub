// Prisma Schema for Operations Control Panel
// Core system entities only - no business data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & AUTHORIZATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  // Status fields - separate account status from verification
  accountStatus AccountStatus @default(ACTIVE) @map("account_status")
  emailVerified Boolean   @default(false) @map("email_verified")
  // Deactivation tracking
  deactivatedAt DateTime? @map("deactivated_at")
  deactivatedBy String?   @map("deactivated_by")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Preferences
  themePreference ThemePreference @default(SYSTEM) @map("theme_preference")

  // Relations
  roles         UserRole[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  salesQuotes   Quote[] @relation("SalesRepQuotes")
  quoteApprovals QuoteApprovalAudit[] @relation("QuoteApprovalActors")
  notifications Notification[] @relation("UserNotifications")
  workOrders       WorkOrder[] @relation("WorkOrderAssignments")
  assetHistory     AssetHistory[] @relation("AssetHistoryActors")
  createdInviteCodes InviteCode[] @relation("InviteCodeCreator")
  usedInviteCode     InviteCode?  @relation("InviteCodeUser")

  @@index([accountStatus])
  @@index([emailVerified])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  module      String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  roles RolePermission[]

  @@index([module])
  @@map("permissions")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================================================
// AUDIT & SYSTEM
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("system_settings")
}

// Invite Code for user registration
model InviteCode {
  id          String    @id @default(cuid())
  code        String    @unique
  createdBy   String    @map("created_by") // User ID of admin who created it
  usedBy      String?   @unique @map("used_by") // User ID who used it (null if unused) - unique since one user can only use one code
  usedAt      DateTime? @map("used_at")
  expiresAt   DateTime? @map("expires_at") // Optional expiration
  maxUses     Int       @default(1) @map("max_uses") // How many times it can be used
  useCount    Int       @default(0) @map("use_count") // How many times it's been used
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  creator User? @relation("InviteCodeCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  user    User? @relation("InviteCodeUser", fields: [usedBy], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([createdBy])
  @@index([isActive])
  @@index([expiresAt])
  @@map("invite_codes")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AccountStatus {
  ACTIVE
  DISABLED
  PENDING
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}

// ============================================================================
// SALES QUOTE SYSTEM
// ============================================================================

enum CustomerType {
  INDIVIDUAL
  COMPANY
}

enum DeliveryMethod {
  DELIVERED
  COLLECTED
}

enum QuoteStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  WON
  LOST
}

enum PaymentTerms {
  CASH_ON_DELIVERY
  DAYS_15
  DAYS_30
}

enum TruckType {
  TIPPER_42T
  CANTER
}

enum LossReasonCategory {
  PRICE_TOO_HIGH
  FOUND_BETTER_DEAL
  PROJECT_CANCELLED
  DELIVERY_TIMING
  QUALITY_CONCERNS
  OTHER
}

enum ApprovalAction {
  SUBMIT
  APPROVE
  REJECT
  WITHDRAW
  MARK_WON
  MARK_LOST
}

// Company Directory
model Company {
  id             String    @id @default(cuid())
  name           String
  legalName      String?   @map("legal_name")
  registrationNo String?   @map("registration_no")
  taxNo          String?   @map("tax_no")
  addressLine1   String?   @map("address_line1")
  addressLine2   String?   @map("address_line2")
  city           String?
  state          String?
  postalCode     String?   @map("postal_code")
  country        String?
  phone          String?
  email          String?
  logoUrl        String?   @map("logo_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  projects       Project[]
  warehouses     Warehouse[]
  quotes         Quote[]

  @@map("companies")
}

// Project
model Project {
  id        String    @id @default(cuid())
  companyId String    @map("company_id")
  name      String
  code      String?
  region    String?
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  warehouses  Warehouse[]
  stockItems  StockItem[]
  quotes      Quote[]

  @@index([companyId])
  assets           Asset[]
  @@map("projects")
}

// Warehouse
model Warehouse {
  id        String    @id @default(cuid())
  companyId String    @map("company_id")
  projectId String?   @map("project_id")
  name      String
  locationCity String? @map("location_city")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project    Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  stockItems StockItem[]

  @@index([companyId])
  @@index([projectId])
  assets           Asset[]
  spareParts        SparePart[]
  @@map("warehouses")
}

// Customer
model Customer {
  id                    String       @id @default(cuid())
  type                  CustomerType
  // Individual fields
  firstName             String?      @map("first_name")
  lastName              String?       @map("last_name")
  // Company fields
  companyName           String?      @map("company_name")
  // Common fields
  billingAddressLine1   String       @map("billing_address_line1")
  billingAddressLine2   String?      @map("billing_address_line2")
  billingCity           String       @map("billing_city")
  billingState          String?      @map("billing_state")
  billingPostalCode     String       @map("billing_postal_code")
  billingCountry        String?      @map("billing_country")
  deliveryAddressLine1  String?      @map("delivery_address_line1")
  deliveryAddressLine2  String?      @map("delivery_address_line2")
  deliveryCity          String?      @map("delivery_city")
  deliveryState         String?      @map("delivery_state")
  deliveryPostalCode    String?      @map("delivery_postal_code")
  deliveryCountry       String?      @map("delivery_country")
  phone                 String?
  email                 String?
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  // Relations
  contacts              Contact[]
  quotes                Quote[]

  @@index([type])
  @@map("customers")
}

// Contact
model Contact {
  id        String    @id @default(cuid())
  customerId String   @map("customer_id")
  name      String
  roleTitle String?   @map("role_title")
  phone     String?
  email     String?
  isPrimary Boolean   @default(false) @map("is_primary")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  quotes   Quote[]

  @@index([customerId])
  @@map("contacts")
}

// Stock Item (Product)
model StockItem {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  warehouseId    String    @map("warehouse_id")
  name            String
  sku             String?
  uom             String // Unit of measure
  minUnitPrice    Decimal   @map("min_unit_price") @db.Decimal(10, 2)
  defaultUnitPrice Decimal   @map("default_unit_price") @db.Decimal(10, 2)
  minOrderQty     Decimal   @map("min_order_qty") @db.Decimal(10, 2)
  truckloadOnly   Boolean   @default(false) @map("truckload_only")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  quoteItems  QuoteItem[]

  @@index([projectId])
  @@index([warehouseId])
  @@map("stock_items")
}

// Route (Admin-only)
model Route {
  id        String    @id @default(cuid())
  fromCity  String    @map("from_city")
  toCity    String    @map("to_city")
  distanceKm Decimal  @map("distance_km") @db.Decimal(10, 2)
  costPerKm Decimal   @map("cost_per_km") @db.Decimal(10, 2)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  tolls     Toll[]
  quotes    Quote[]

  @@map("routes")
}

// Toll
model Toll {
  id        String    @id @default(cuid())
  routeId   String    @map("route_id")
  name      String
  cost      Decimal   @db.Decimal(10, 2)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
  @@map("tolls")
}

// Quote
model Quote {
  id                      String         @id @default(cuid())
  quoteNumber             String         @unique @map("quote_number")
  companyId               String         @map("company_id")
  projectId               String         @map("project_id")
  customerId              String         @map("customer_id")
  contactId               String?        @map("contact_id")
  deliveryMethod          DeliveryMethod @map("delivery_method")
  // Delivery address snapshot
  deliveryAddressLine1    String?        @map("delivery_address_line1")
  deliveryAddressLine2    String?        @map("delivery_address_line2")
  deliveryCity            String?        @map("delivery_city")
  deliveryState           String?        @map("delivery_state")
  deliveryPostalCode      String?        @map("delivery_postal_code")
  deliveryCountry         String?        @map("delivery_country")
  // Route snapshot
  routeId                 String?        @map("route_id")
  distanceKmSnapshot      Decimal?       @map("distance_km_snapshot") @db.Decimal(10, 2)
  costPerKmSnapshot       Decimal?       @map("cost_per_km_snapshot") @db.Decimal(10, 2)
  tollTotalSnapshot       Decimal?       @map("toll_total_snapshot") @db.Decimal(10, 2)
  // Totals
  subtotal                Decimal        @db.Decimal(12, 2)
  discountPercentage      Decimal        @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  transportTotal          Decimal        @default(0) @map("transport_total") @db.Decimal(12, 2)
  grandTotal              Decimal        @map("grand_total") @db.Decimal(12, 2)
  // Validity
  validityDays            Int            @default(7) @map("validity_days")
  // Payment Terms
  paymentTerms            PaymentTerms?  @map("payment_terms")
  // Delivery Terms
  deliveryStartDate       DateTime?      @map("delivery_start_date")
  serviceEndDate          DateTime?      @map("service_end_date")
  loadsPerDay             Int?          @map("loads_per_day")
  truckType               TruckType?    @map("truck_type")
  // Status
  status                  QuoteStatus    @default(DRAFT)
  // Sales rep
  salesRepUserId          String         @map("sales_rep_user_id")
  // Relations to User
  salesRep                User           @relation("SalesRepQuotes", fields: [salesRepUserId], references: [id], onDelete: Cascade)
  // Timestamps
  submittedAt             DateTime?      @map("submitted_at")
  approvedAt              DateTime?      @map("approved_at")
  rejectedAt              DateTime?      @map("rejected_at")
  // Outcome (only for LOST quotes)
  lossReasonCategory      LossReasonCategory? @map("loss_reason_category")
  outcomeReasonNotes      String?        @map("outcome_reason_notes")
  createdAt               DateTime       @default(now()) @map("created_at")
  updatedAt               DateTime       @updatedAt @map("updated_at")

  // Relations
  company     Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project     Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  customer    Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact     Contact?             @relation(fields: [contactId], references: [id], onDelete: SetNull)
  route       Route?               @relation(fields: [routeId], references: [id], onDelete: SetNull)
  items       QuoteItem[]
  approvals   QuoteApprovalAudit[]

  @@index([companyId])
  @@index([projectId])
  @@index([customerId])
  @@index([salesRepUserId])
  @@index([status])
  @@index([quoteNumber])
  @@map("quotes")
}

// Quote Item
model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String   @map("quote_id")
  stockItemId String   @map("stock_item_id")
  // Snapshots
  nameSnapshot String  @map("name_snapshot")
  uomSnapshot  String  @map("uom_snapshot")
  // Pricing
  qty          Decimal  @db.Decimal(10, 2)
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  discountPercentage Decimal  @default(0) @map("discount_percentage") @db.Decimal(5, 2)
  lineTotal    Decimal  @map("line_total") @db.Decimal(12, 2)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  quote     Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  stockItem StockItem  @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([stockItemId])
  @@map("quote_items")
}

// Quote Approval Audit
model QuoteApprovalAudit {
  id        String         @id @default(cuid())
  quoteId   String         @map("quote_id")
  action    ApprovalAction
  actorUserId String       @map("actor_user_id")
  // Relations to User
  actor                    User           @relation("QuoteApprovalActors", fields: [actorUserId], references: [id], onDelete: Cascade)
  notes     String?
  createdAt DateTime       @default(now()) @map("created_at")

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([actorUserId])
  @@map("quote_approval_audits")
}

// Notifications
model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String   // e.g., 'quote_approved', 'quote_rejected', 'quote_submitted'
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?  // Optional link to related resource
  createdAt DateTime @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")

  // Relations
  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}
// ============================================================================
// ASSETS & MAINTENANCE SYSTEM
// ============================================================================

enum AssetStatus {
  OPERATIONAL
  MAINTENANCE
  BROKEN
  RETIRED
}

enum AssetCriticality {
  LOW
  MEDIUM
  HIGH
}

enum MaintenanceScheduleType {
  TIME_BASED
  USAGE_BASED
}

enum WorkOrderType {
  PREVENTIVE
  CORRECTIVE
  INSPECTION
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  WAITING_PARTS
  COMPLETED
  CANCELLED
}

enum DepreciationMethod {
  STRAIGHT_LINE
  DECLINING_BALANCE
}

enum AssetHistoryEventType {
  CREATED
  STATUS_CHANGED
  MAINTENANCE_DONE
  WORK_ORDER_COMPLETED
  PART_CONSUMED
  COST_UPDATED
  RETIRED
}

// Asset Registry
model Asset {
  id                String            @id @default(cuid())
  assetTag          String            @unique @map("asset_tag")
  name              String
  category          String            // Crusher, Truck, Generator, etc.
  manufacturer      String?
  model             String?
  serialNumber      String?           @map("serial_number")
  acquisitionDate   DateTime          @map("acquisition_date")
  acquisitionCost   Decimal           @map("acquisition_cost") @db.Decimal(12, 2)
  currentValue      Decimal           @map("current_value") @db.Decimal(12, 2)
  status            AssetStatus       @default(OPERATIONAL)
  location          String?           // site / project / warehouse
  projectId         String?           @map("project_id")
  warehouseId       String?           @map("warehouse_id")
  assignedTo        String?           @map("assigned_to") // operator or department
  criticality        AssetCriticality  @default(MEDIUM)
  expectedLifeYears Int?              @map("expected_life_years")
  notes             String?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  // Relations
  project            Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  warehouse          Warehouse?       @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  maintenanceSchedules MaintenanceSchedule[]
  workOrders        WorkOrder[]
  history           AssetHistory[]
  depreciationProfile DepreciationProfile?
  depreciationEntries DepreciationEntry[]

  @@index([assetTag])
  @@index([status])
  @@index([category])
  @@index([projectId])
  @@index([warehouseId])
  @@map("assets")
}

// Maintenance Schedules (Preventive)
model MaintenanceSchedule {
  id                  String                  @id @default(cuid())
  assetId             String                  @map("asset_id")
  type                MaintenanceScheduleType
  intervalDays        Int?                    @map("interval_days") // for time-based
  intervalHours       Int?                    @map("interval_hours") // for usage-based
  checklistJson       Json?                   @map("checklist_json")
  estimatedDurationHours Decimal?             @map("estimated_duration_hours") @db.Decimal(5, 2)
  requiredPartsJson   Json?                   @map("required_parts_json")
  isActive            Boolean                 @default(true) @map("is_active")
  lastPerformedAt     DateTime?               @map("last_performed_at")
  nextDueAt           DateTime?               @map("next_due_at")
  createdAt           DateTime                @default(now()) @map("created_at")
  updatedAt           DateTime                @updatedAt @map("updated_at")

  // Relations
  asset               Asset                   @relation(fields: [assetId], references: [id], onDelete: Cascade)
  workOrders          WorkOrder[]

  @@index([assetId])
  @@index([isActive])
  @@index([nextDueAt])
  @@map("maintenance_schedules")
}

// Work Orders (Corrective + Preventive)
model WorkOrder {
  id              String            @id @default(cuid())
  assetId         String            @map("asset_id")
  scheduleId      String?           @map("schedule_id")
  type            WorkOrderType
  priority        WorkOrderPriority @default(MEDIUM)
  status          WorkOrderStatus   @default(OPEN)
  description     String
  assignedToUserId String?           @map("assigned_to_user_id")
  startedAt       DateTime?          @map("started_at")
  completedAt    DateTime?          @map("completed_at")
  downtimeHours  Decimal?           @map("downtime_hours") @db.Decimal(10, 2)
  laborCost      Decimal            @default(0) @map("labor_cost") @db.Decimal(12, 2)
  partsCost      Decimal            @default(0) @map("parts_cost") @db.Decimal(12, 2)
  totalCost      Decimal            @default(0) @map("total_cost") @db.Decimal(12, 2)
  notes          String?
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Relations
  asset           Asset             @relation(fields: [assetId], references: [id], onDelete: Cascade)
  schedule        MaintenanceSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  assignedTo      User?             @relation("WorkOrderAssignments", fields: [assignedToUserId], references: [id], onDelete: SetNull)
  partUsages      PartUsage[]

  @@index([assetId])
  @@index([scheduleId])
  @@index([status])
  @@index([assignedToUserId])
  @@index([createdAt])
  @@map("work_orders")
}

// Spare Parts
model SparePart {
  id              String      @id @default(cuid())
  name            String
  sku             String      @unique
  uom             String      // Unit of measure
  warehouseId     String      @map("warehouse_id")
  quantityOnHand  Decimal     @default(0) @map("quantity_on_hand") @db.Decimal(10, 2)
  minStockLevel   Decimal     @default(0) @map("min_stock_level") @db.Decimal(10, 2)
  unitCost        Decimal     @map("unit_cost") @db.Decimal(10, 2)
  isCritical      Boolean     @default(false) @map("is_critical")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  warehouse       Warehouse   @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  partUsages      PartUsage[]

  @@index([sku])
  @@index([warehouseId])
  @@map("spare_parts")
}

// Part Usage (consumption tracking)
model PartUsage {
  id              String      @id @default(cuid())
  workOrderId     String      @map("work_order_id")
  sparePartId     String      @map("spare_part_id")
  quantityUsed    Decimal     @map("quantity_used") @db.Decimal(10, 2)
  costSnapshot    Decimal     @map("cost_snapshot") @db.Decimal(10, 2)
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  workOrder       WorkOrder   @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  sparePart       SparePart   @relation(fields: [sparePartId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([sparePartId])
  @@map("part_usages")
}

// Asset History (Immutable Log)
model AssetHistory {
  id              String                @id @default(cuid())
  assetId         String                @map("asset_id")
  eventType       AssetHistoryEventType @map("event_type")
  metadataJson    Json?                 @map("metadata_json")
  actorUserId     String?               @map("actor_user_id")
  createdAt       DateTime              @default(now()) @map("created_at")

  // Relations
  asset           Asset                 @relation(fields: [assetId], references: [id], onDelete: Cascade)
  actor           User?                 @relation("AssetHistoryActors", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([assetId])
  @@index([eventType])
  @@index([createdAt])
  @@map("asset_history")
}

// Depreciation Profile
model DepreciationProfile {
  id              String              @id @default(cuid())
  assetId         String              @unique @map("asset_id")
  method          DepreciationMethod
  usefulLifeYears Int                 @map("useful_life_years")
  salvageValue    Decimal             @map("salvage_value") @db.Decimal(12, 2)
  startDate       DateTime            @map("start_date")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  // Relations
  asset           Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  entries         DepreciationEntry[]

  @@index([assetId])
  @@map("depreciation_profiles")
}

// Depreciation Entry
model DepreciationEntry {
  id                  String              @id @default(cuid())
  assetId             String              @map("asset_id")
  profileId           String              @map("profile_id")
  period              String              // YYYY-MM format
  depreciationAmount  Decimal             @map("depreciation_amount") @db.Decimal(12, 2)
  bookValueAfter      Decimal             @map("book_value_after") @db.Decimal(12, 2)
  isPosted            Boolean             @default(false) @map("is_posted")
  postedAt            DateTime?           @map("posted_at")
  createdAt           DateTime            @default(now()) @map("created_at")

  // Relations
  asset               Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  profile             DepreciationProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([assetId, period])
  @@index([assetId])
  @@index([profileId])
  @@index([period])
  @@index([isPosted])
  @@map("depreciation_entries")
}

