// Prisma Schema for Operations Control Panel
// Core system entities only - no business data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & AUTHORIZATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  // Status fields - separate account status from verification
  accountStatus AccountStatus @default(ACTIVE) @map("account_status")
  emailVerified Boolean   @default(false) @map("email_verified")
  // Deactivation tracking
  deactivatedAt DateTime? @map("deactivated_at")
  deactivatedBy String?   @map("deactivated_by")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Preferences
  themePreference ThemePreference @default(SYSTEM) @map("theme_preference")

  // Relations
  roles         UserRole[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  salesQuotes   Quote[] @relation("SalesRepQuotes")
  quoteApprovals QuoteApprovalAudit[] @relation("QuoteApprovalActors")
  notifications Notification[] @relation("UserNotifications")


  @@index([accountStatus])
  @@index([emailVerified])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  module      String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  roles RolePermission[]

  @@index([module])
  @@map("permissions")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  roleId    String   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================================================
// AUDIT & SYSTEM
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String?  @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@map("system_settings")
}

// ============================================================================
// ENUMS
// ============================================================================

enum AccountStatus {
  ACTIVE
  DISABLED
  PENDING
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}

// ============================================================================
// SALES QUOTE SYSTEM
// ============================================================================

enum CustomerType {
  INDIVIDUAL
  COMPANY
}

enum DeliveryMethod {
  DELIVERED
  COLLECTED
}

enum QuoteStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  WON
  LOST
}

enum ApprovalAction {
  SUBMIT
  APPROVE
  REJECT
  WITHDRAW
  MARK_WON
  MARK_LOST
}

// Company Directory
model Company {
  id             String    @id @default(cuid())
  name           String
  legalName      String?   @map("legal_name")
  registrationNo String?   @map("registration_no")
  taxNo          String?   @map("tax_no")
  addressLine1   String?   @map("address_line1")
  addressLine2   String?   @map("address_line2")
  city           String?
  state          String?
  postalCode     String?   @map("postal_code")
  country        String?
  phone          String?
  email          String?
  logoUrl        String?   @map("logo_url")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  projects       Project[]
  warehouses     Warehouse[]
  quotes         Quote[]

  @@map("companies")
}

// Project
model Project {
  id        String    @id @default(cuid())
  companyId String    @map("company_id")
  name      String
  code      String?
  region    String?
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  warehouses  Warehouse[]
  stockItems  StockItem[]
  quotes      Quote[]

  @@index([companyId])
  @@map("projects")
}

// Warehouse
model Warehouse {
  id        String    @id @default(cuid())
  companyId String    @map("company_id")
  projectId String?   @map("project_id")
  name      String
  locationCity String? @map("location_city")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project    Project?   @relation(fields: [projectId], references: [id], onDelete: SetNull)
  stockItems StockItem[]

  @@index([companyId])
  @@index([projectId])
  @@map("warehouses")
}

// Customer
model Customer {
  id                    String       @id @default(cuid())
  type                  CustomerType
  // Individual fields
  firstName             String?      @map("first_name")
  lastName              String?       @map("last_name")
  // Company fields
  companyName           String?      @map("company_name")
  // Common fields
  billingAddressLine1   String       @map("billing_address_line1")
  billingAddressLine2   String?      @map("billing_address_line2")
  billingCity           String       @map("billing_city")
  billingState          String?      @map("billing_state")
  billingPostalCode     String       @map("billing_postal_code")
  billingCountry        String?      @map("billing_country")
  deliveryAddressLine1  String?      @map("delivery_address_line1")
  deliveryAddressLine2  String?      @map("delivery_address_line2")
  deliveryCity          String?      @map("delivery_city")
  deliveryState         String?      @map("delivery_state")
  deliveryPostalCode    String?      @map("delivery_postal_code")
  deliveryCountry       String?      @map("delivery_country")
  phone                 String?
  email                 String?
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  // Relations
  contacts              Contact[]
  quotes                Quote[]

  @@index([type])
  @@map("customers")
}

// Contact
model Contact {
  id        String    @id @default(cuid())
  customerId String   @map("customer_id")
  name      String
  roleTitle String?   @map("role_title")
  phone     String?
  email     String?
  isPrimary Boolean   @default(false) @map("is_primary")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  quotes   Quote[]

  @@index([customerId])
  @@map("contacts")
}

// Stock Item (Product)
model StockItem {
  id              String    @id @default(cuid())
  projectId       String    @map("project_id")
  warehouseId    String    @map("warehouse_id")
  name            String
  sku             String?
  uom             String // Unit of measure
  minUnitPrice    Decimal   @map("min_unit_price") @db.Decimal(10, 2)
  defaultUnitPrice Decimal   @map("default_unit_price") @db.Decimal(10, 2)
  minOrderQty     Decimal   @map("min_order_qty") @db.Decimal(10, 2)
  truckloadOnly   Boolean   @default(false) @map("truckload_only")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  warehouse   Warehouse    @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  quoteItems  QuoteItem[]

  @@index([projectId])
  @@index([warehouseId])
  @@map("stock_items")
}

// Route (Admin-only)
model Route {
  id        String    @id @default(cuid())
  fromCity  String    @map("from_city")
  toCity    String    @map("to_city")
  distanceKm Decimal  @map("distance_km") @db.Decimal(10, 2)
  costPerKm Decimal   @map("cost_per_km") @db.Decimal(10, 2)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  tolls     Toll[]
  quotes    Quote[]

  @@map("routes")
}

// Toll
model Toll {
  id        String    @id @default(cuid())
  routeId   String    @map("route_id")
  name      String
  cost      Decimal   @db.Decimal(10, 2)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([routeId])
  @@map("tolls")
}

// Quote
model Quote {
  id                      String         @id @default(cuid())
  quoteNumber             String         @unique @map("quote_number")
  companyId               String         @map("company_id")
  projectId               String         @map("project_id")
  customerId              String         @map("customer_id")
  contactId               String?        @map("contact_id")
  deliveryMethod          DeliveryMethod @map("delivery_method")
  // Delivery address snapshot
  deliveryAddressLine1    String?        @map("delivery_address_line1")
  deliveryAddressLine2    String?        @map("delivery_address_line2")
  deliveryCity            String?        @map("delivery_city")
  deliveryState           String?        @map("delivery_state")
  deliveryPostalCode      String?        @map("delivery_postal_code")
  deliveryCountry         String?        @map("delivery_country")
  // Route snapshot
  routeId                 String?        @map("route_id")
  distanceKmSnapshot      Decimal?       @map("distance_km_snapshot") @db.Decimal(10, 2)
  costPerKmSnapshot       Decimal?       @map("cost_per_km_snapshot") @db.Decimal(10, 2)
  tollTotalSnapshot       Decimal?       @map("toll_total_snapshot") @db.Decimal(10, 2)
  // Totals
  subtotal                Decimal        @db.Decimal(12, 2)
  discountTotal           Decimal        @default(0) @map("discount_total") @db.Decimal(12, 2)
  transportTotal          Decimal        @default(0) @map("transport_total") @db.Decimal(12, 2)
  grandTotal              Decimal        @map("grand_total") @db.Decimal(12, 2)
  // Status
  status                  QuoteStatus    @default(DRAFT)
  // Sales rep
  salesRepUserId          String         @map("sales_rep_user_id")
  // Relations to User
  salesRep                User           @relation("SalesRepQuotes", fields: [salesRepUserId], references: [id], onDelete: Cascade)
  // Timestamps
  submittedAt             DateTime?      @map("submitted_at")
  approvedAt              DateTime?      @map("approved_at")
  rejectedAt              DateTime?      @map("rejected_at")
  // Outcome
  outcomeReasonCategory   String?        @map("outcome_reason_category")
  outcomeReasonNotes      String?        @map("outcome_reason_notes")
  createdAt               DateTime       @default(now()) @map("created_at")
  updatedAt               DateTime       @updatedAt @map("updated_at")

  // Relations
  company     Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  project     Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  customer    Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact     Contact?             @relation(fields: [contactId], references: [id], onDelete: SetNull)
  route       Route?               @relation(fields: [routeId], references: [id], onDelete: SetNull)
  items       QuoteItem[]
  approvals   QuoteApprovalAudit[]

  @@index([companyId])
  @@index([projectId])
  @@index([customerId])
  @@index([salesRepUserId])
  @@index([status])
  @@index([quoteNumber])
  @@map("quotes")
}

// Quote Item
model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String   @map("quote_id")
  stockItemId String   @map("stock_item_id")
  // Snapshots
  nameSnapshot String  @map("name_snapshot")
  uomSnapshot  String  @map("uom_snapshot")
  // Pricing
  qty          Decimal  @db.Decimal(10, 2)
  unitPrice    Decimal  @map("unit_price") @db.Decimal(10, 2)
  discount     Decimal  @default(0) @db.Decimal(10, 2)
  lineTotal    Decimal  @map("line_total") @db.Decimal(12, 2)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  quote     Quote      @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  stockItem StockItem  @relation(fields: [stockItemId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([stockItemId])
  @@map("quote_items")
}

// Quote Approval Audit
model QuoteApprovalAudit {
  id        String         @id @default(cuid())
  quoteId   String         @map("quote_id")
  action    ApprovalAction
  actorUserId String       @map("actor_user_id")
  // Relations to User
  actor                    User           @relation("QuoteApprovalActors", fields: [actorUserId], references: [id], onDelete: Cascade)
  notes     String?
  createdAt DateTime       @default(now()) @map("created_at")

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([actorUserId])
  @@map("quote_approval_audits")
}

// Notifications
model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String   // e.g., 'quote_approved', 'quote_rejected', 'quote_submitted'
  title     String
  message   String
  read      Boolean  @default(false)
  link      String?  // Optional link to related resource
  createdAt DateTime @default(now()) @map("created_at")
  readAt    DateTime? @map("read_at")

  // Relations
  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}
