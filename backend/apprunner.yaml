version: 1.0
runtime: nodejs20
build:
  commands:
    build:
      - echo "Installing pnpm..."
      - corepack enable
      - corepack prepare pnpm@latest --activate
      - echo "Installing dependencies..."
      - cd backend
      - pnpm install --frozen-lockfile
      - echo "Generating Prisma client..."
      - pnpm prisma generate
      - echo "Building application..."
      - pnpm build
run:
  runtime-version: 20
  command: sh -c "cd backend && pnpm prisma migrate deploy && node dist/src/main.js"
  network:
    port: 3000
    env: PORT
  env:
    - name: NODE_ENV
      value: "production"
    - name: DATABASE_URL
      value-from: "arn:aws:secretsmanager:REGION:ACCOUNT_ID:secret:ocp-database-url"
    - name: JWT_SECRET
      value-from: "arn:aws:secretsmanager:REGION:ACCOUNT_ID:secret:ocp-jwt-secret"
    - name: JWT_REFRESH_SECRET
      value-from: "arn:aws:secretsmanager:REGION:ACCOUNT_ID:secret:ocp-jwt-refresh-secret"
    - name: CORS_ORIGIN
      value: "https://alphapms.app,https://www.alphapms.app"
